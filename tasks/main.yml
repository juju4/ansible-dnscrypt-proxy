---
## http://dnscrypt.org/
## https://github.com/opendns/dnscrypt-proxy
## http://dnscrypt.org/#dnscrypt-proxy

- name: Include version-specific variables for Ubuntu.
  include_vars: "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml"
  when: ansible_distribution == 'Ubuntu'
- name: Include version-specific variables for RedHat
  include_vars: "CentOS-{{ ansible_distribution_version.split('.')[0] }}.yml"
  when: ansible_os_family == "RedHat" or ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- block:
    - name: ensure python pip is present
      package: name={{ item }} state=present
      with_items: "{{ python_sni }}"
    - include: pip-upgrade.yml
    - name: upgrade python-six to latest with pip - 1.6+ required for ndg-httpsclient
      pip: name=six version=1.6.0
    - name: old python - SNI workaround
      pip: name={{ item }} state=present
      with_items:
        - urllib3
        - pyopenssl
        - ndg-httpsclient
        - pyasn1
  when: ansible_distribution_release == 'trusty' or ansible_distribution_major_version <= 7

- name: Ubuntu | ppa install
  include: ubuntu.yml
  when: ansible_distribution == 'Ubuntu' and not dnscryptproxy_force_source

- name: Redhat | requirements
  include: redhat.yml
  when: ansible_os_family == "RedHat" or ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: Source install
  include: source.yml
#  when: ansible_distribution != 'Ubuntu'
  when: ansible_os_family == "RedHat" or ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux' or dnscryptproxy_force_source

## Not possible in docker testing, https://github.com/docker/docker/issues/1297
- name: enable dnscrypt in resolv.conf
  lineinfile: dest=/etc/resolv.conf line="nameserver 127.0.0.2" insertbefore=BOF backup=yes
  when:  ansible_virtualization_type is not defined or ansible_virtualization_type != 'docker' 

- name: Ensure nrpe.d dir exists
  file: dest=/etc/nagios/nrpe.d state=directory mode=0755
- name: add some nrpe commands for monitoring
  copy: src=dnscrypt-nrpe.cfg dest=/etc/nagios/nrpe.d/dnscrypt-nrpe.cfg mode=0644

## http://bluepilltech.blogspot.ca/2015/05/configuring-openbsd-57s-default-unbound.html

#- name: check dns working
#  command: host www.google.com
#  register: hosttest
#- name: host dns resolution failed
#  fail: msg="host dns resolution failed"
#  when: "'SERVFAIL' in hosttest.stderr"
#- name: check DNSSEC is active
#  command: drill -S freebsd.org
#  register: dnssectest
#- name: DNSSEC is working
#  fail: msg="DNSSEC resolution failed"
#  when: dnssectest.stdout.find('DNSKEY') != -1
#  ignore_errors: yes        ## on centos7, fails in ansible, succeed in cli...
## OR: dig . SOA +dnssec |grep RRSIG

